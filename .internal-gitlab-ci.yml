variables:
  SCHEDULER_PARAMETERS: '--nodes=1 --partition=power9 --export=NONE'
  GIT_SUBMODULE_STRATEGY: recursive
  MODULE_CMAKE: "cmake/3.11.1"
  MODULE_CLANG: "clang/8.0.1"
  MODULE_COMPILER: "ibm/xlc-16.1.1.7-xlf-16.1.1.7-gcc-7.4.0"
  MODULE_CUDA: "cuda/10.1"
  MODULE_MPI: "openmpi/p9/4.0.1-gcc_7.4.0"
  CMAKE_BUILD_TYPE: "Release" 
  Kokkos_ARCH_POWER9: "ON" 
  Kokkos_ARCH_VOLTA70: "ON" 
  Kokkos_ENABLE_CUDA: "ON" 
  Kokkos_ENABLE_CUDA_UVM: "OFF"
  Kokkos_ENABLE_CXX11: "ON" 
  Kokkos_ENABLE_OPENMP: "ON" 
  PARTHENON_DISABLE_HDF5: "OFF" 

stages:
  - performance-regression

# Is performed before the scripts in the stages step
before_script:
  - git clone https://github.com/lanl/parthenon-buildenv.git
  - env -i bash ./parthenon-buildenv/internal/scripts/setup.sh

parthenon-power9-gcc-mpi-performance-regression:
  variables: 
    BUILD_DIR: "build_power9_perf_regression_gcc_mpi"
    CMAKE_CXX_COMPILER: $CI_PROJECT_DIR/external/Kokkos/bin/nvcc_wrapper
  stage: performance-regression
  script:
    - >
      env -i bash ./parthenon-buildenv/internal/scripts/build.sh
      ${BUILD_DIR}
      ${CMAKE_BUILD_TYPE}
      ${CMAKE_CXX_COMPILER}
      ${Kokkos_ARCH_POWER9}
      ${Kokkos_ARCH_VOLTA70}
      ${Kokkos_ENABLE_CUDA}
      ${Kokkos_ENABLE_CUDA_UVM}
      ${Kokkos_ENABLE_CXX11}
      ${Kokkos_ENABLE_OPENMP}
      ${PARTHENON_DISABLE_HDF5}
  artifacts:
    when: always
    expire_in: 3 days
    paths:
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/tst/regression/advection_convergence/advection-errors.dat
      - ${CI_PROJECT_DIR}/${BUILD_DIR}/tst/regression/outputs/advection_convergence/advection-errors.png



